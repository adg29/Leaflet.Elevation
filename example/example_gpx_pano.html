<!DOCTYPE html>
<html>
<head>
	<title>Leaflet.Elevation</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	 <style>
	   html, body, #map {
	      height:100%;
	      width:100%;
	      padding:0px;
	      margin:0px;
	   }
	</style>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.ie.css" /><![endif]-->

	<link rel="stylesheet" href="../dist/leaflet.elevation-0.0.4.css" />

	<script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<script type="text/javascript" src="../dist/leaflet.elevation-0.0.4.src.js"></script
	>
	<script type="text/javascript" src="./lib/leaflet-gpx/gpx.js"></script>
	<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyC7r39DIwo3x6qRS6bZFHVmxjT5hBCP9fA"></script>
	<script   src="https://code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
</head>
<body>


<div id="pano" style="width: 550px; height: 350px;"></div>

	<div id="map"></div>

	<script type="text/javascript">
		var map = new L.Map('map');



// var service = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//   attribution: 'Map data &copy; <a href="http://www.osm.org">OpenStreetMap</a>'
// }).addTo(map);


		var url = 'http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg',
		url = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
			attr ='Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
			service = new L.TileLayer(url, {subdomains:"1234",attribution: attr}),
			service = new L.TileLayer(url, {attribution: attr});

		map.addLayer(service);
		var el = L.control.elevation();
		el.addTo(map);
		var g=new L.GPX("./demo.gpx", {
			async: true,
			 marker_options: {
			    startIconUrl: './lib/leaflet-gpx/pin-icon-start.png',
			    endIconUrl: './lib/leaflet-gpx/pin-icon-end.png',
			    shadowUrl: './lib/leaflet-gpx/pin-shadow.png'
			  }
		});
		g.on('loaded', function(e) {
		  		map.fitBounds(e.target.getBounds());
		});
		g.on("addline",function(e){
			el.addData(e.line);
		});
		g.addTo(map);

		map.on("trackClick",function(llClick){
			console.log(llClick,llClick.latlng.lat,llClick.latlng.lng);
			getPano(llClick.latlng);
		})


var sv;
function getUrlVars() {
  var vars = {};
  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
    vars[key] = value;
  });
  return vars;
}

//credit: http://stackoverflow.com/a/13568401/52160
function initMap() {
  console.log('initMap called');
  var parts = getUrlVars();

  var res = {
    lat: -45.8889369,
    lng: 170.5075171
  };

sv = new google.maps.StreetViewService();

  panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'));

  getPano(res);

}

function getPano(ll){
  sv.getPanorama({
    location: {
      lat: ll.lat,
      lng: ll.lng
    },
    radius: 50
  }, processSVData)

}

function processSVData(data, status) {
  if (status === google.maps.StreetViewStatus.OK) {
    console.log('ok');
    $('#pano').animate({ opacity: 1 });
    panorama.setPano(data.location.pano);

    panorama.setPov({
      heading: 270,
      pitch: 0
    });

    panorama.setVisible(true);

  } else {
    console.log('Street View data not found for this location.');
    $('#pano').animate({ opacity: 0 });
  }
}

google.maps.event.addDomListener(window, 'load', initMap);

	</script>
</body>
</html>
